<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üèÄ Asistencia Basketball</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ‚úÖ CORRECTO: usamos lucide (no lucide-react) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    // ‚úÖ corregido: usamos 'lucide' en vez de 'lucideReact'
    const { Camera, Users, QrCode, ClipboardList, Plus, Download, BarChart3, RefreshCw, Wifi, WifiOff, MapPin } = lucide;

    const App = () => {
      const [view, setView] = useState('menu');
      const [players, setPlayers] = useState([]);
      const [sessions, setSessions] = useState([]);
      const [currentSession, setCurrentSession] = useState(null);
      const [newPlayer, setNewPlayer] = useState({ name: '', number: '', team: '', serie: '', email: '', phone: '' });
      const [sessionInfo, setSessionInfo] = useState({ type: 'Entrenamiento', location: '', notes: '' });
      const [scanning, setScanning] = useState(false);
      const [connected, setConnected] = useState(false);
      const [loading, setLoading] = useState(false);
      const [config, setConfig] = useState({ sheetId: '', apiKey: '' });
      const [showConfig, setShowConfig] = useState(false);

      const videoRef = useRef(null);
      const streamRef = useRef(null);

      useEffect(() => {
        const saved = localStorage.getItem('bb_config');
        if (saved) {
          const parsed = JSON.parse(saved);
          setConfig(parsed);
          if (parsed.sheetId && parsed.apiKey) loadFromSheets(parsed);
        } else {
          setShowConfig(true);
        }
      }, []);

      const loadFromSheets = async (cfg = config) => {
        if (!cfg.sheetId || !cfg.apiKey) return;
        setLoading(true);
        try {
          const base = `https://sheets.googleapis.com/v4/spreadsheets/${cfg.sheetId}/values/`;
          const [pRes, sRes] = await Promise.all([
            fetch(`${base}Jugadores!A2:G?key=${cfg.apiKey}`),
            fetch(`${base}Sesiones!A2:F?key=${cfg.apiKey}`)
          ]);
          const [pData, sData] = await Promise.all([pRes.json(), sRes.json()]);
          if (pData.values) {
            setPlayers(pData.values.map(r => ({
              id: r[0], name: r[1], number: r[2], team: r[3], serie: r[4], email: r[5], phone: r[6]
            })));
          }
          if (sData.values) {
            setSessions(sData.values.map(r => ({
              id: r[0], date: r[1], type: r[2], location: r[3], attendance: r[4]?.split(',') || [], notes: r[5]
            })));
          }
          setConnected(true);
          alert('‚úì Datos cargados');
        } catch {
          alert('‚ùå Error conectando');
          setConnected(false);
        }
        setLoading(false);
      };

      const saveToSheet = async (sheet, values) => {
        try {
          await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${config.sheetId}/values/${sheet}!A:Z:append?valueInputOption=RAW&key=${config.apiKey}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ values: [values] })
            }
          );
          return true;
        } catch {
          return false;
        }
      };

      const addPlayer = async () => {
        if (!newPlayer.name || !newPlayer.number) return alert('‚ùå Completa nombre y n√∫mero');
        if (players.find(p => p.number === newPlayer.number)) return alert('‚ùå N√∫mero duplicado');
        const player = { id: Date.now().toString(), ...newPlayer };
        if (connected) {
          const saved = await saveToSheet('Jugadores', [player.id, player.name, player.number, player.team, player.serie, player.email, player.phone]);
          if (!saved) return alert('‚ùå Error guardando');
        }
        setPlayers([...players, player]);
        setNewPlayer({ name: '', number: '', team: '', serie: '', email: '', phone: '' });
        alert('‚úì Jugador agregado');
      };

      const startSession = () => {
        if (players.length === 0) {
          alert('‚ùå Primero agrega jugadores');
          return setView('players');
        }
        setCurrentSession({
          id: Date.now().toString(),
          date: new Date().toISOString(),
          type: sessionInfo.type,
          location: sessionInfo.location,
          attendance: [],
          notes: sessionInfo.notes
        });
        setView('scanner');
      };

      const markAttendance = (playerId) => {
        if (!currentSession) return;
        const player = players.find(p => p.id === playerId);
        if (!player) return alert('‚ùå Jugador no encontrado');
        if (currentSession.attendance.includes(playerId)) return alert(`${player.name} ya registrado`);
        const updated = { ...currentSession, attendance: [...currentSession.attendance, playerId] };
        setCurrentSession(updated);
        if (navigator.vibrate) navigator.vibrate(100);
        alert(`‚úì ${player.name} (#${player.number})`);
      };

      const endSession = () => {
        if (!currentSession?.attendance.length) return alert('‚ùå No hay asistencias');
        setSessions([...sessions, currentSession]);
        setCurrentSession(null);
        setSessionInfo({ type: 'Entrenamiento', location: '', notes: '' });
        setView('menu');
        alert('‚úì Sesi√≥n guardada');
      };

      const getStats = (id) => {
        const attended = sessions.filter(s => s.attendance.includes(id)).length;
        const total = sessions.length;
        return { attended, total, percentage: total ? Math.round((attended/total)*100) : 0 };
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-orange-500 to-red-600 p-4">
          <div className="max-w-4xl mx-auto">
            <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">

              <div className="bg-gradient-to-r from-orange-600 to-red-600 p-6 text-white">
                <div className="flex justify-between items-start">
                  <div>
                    <h1 className="text-3xl font-bold">üèÄ Asistencia Basketball</h1>
                    <p className="text-orange-100 mt-1">Sistema integrado con Google Sheets</p>
                  </div>
                  <button
                    onClick={() => setShowConfig(!showConfig)}
                    className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg flex items-center gap-2"
                  >
                    {connected ? <Wifi size={20} /> : <WifiOff size={20} />}
                    {connected ? 'Conectado' : 'Config'}
                  </button>
                </div>
              </div>

              {showConfig && (
                <div className="bg-yellow-50 p-6 border-b-4 border-yellow-400">
                  <h3 className="font-bold mb-3">‚öôÔ∏è Configuraci√≥n Google Sheets</h3>
                  <input type="text" value={config.sheetId} onChange={e=>setConfig({...config, sheetId:e.target.value})} placeholder="Sheet ID" className="w-full p-2 border rounded mb-2"/>
                  <input type="text" value={config.apiKey} onChange={e=>setConfig({...config, apiKey:e.target.value})} placeholder="API Key" className="w-full p-2 border rounded mb-2"/>
                  <div className="flex gap-2">
                    <button onClick={()=>{localStorage.setItem('bb_config',JSON.stringify(config));loadFromSheets(config);setShowConfig(false)}} className="flex-1 bg-green-600 text-white p-2 rounded">Guardar</button>
                    <button onClick={()=>loadFromSheets()} className="px-4 bg-blue-600 text-white rounded flex items-center gap-2"><RefreshCw size={16}/>Recargar</button>
                  </div>
                </div>
              )}

              {loading && <div className="bg-blue-50 p-4 text-center">Cargando datos...</div>}

              {view === 'menu' && (
                <div className="p-6">
                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <button onClick={()=>setView('players')} className="p-6 bg-blue-500 hover:bg-blue-600 text-white rounded-xl flex flex-col items-center gap-2">
                      <Users size={40}/><span className="font-semibold">Jugadores</span><span className="text-sm">{players.length}</span>
                    </button>
                    <button onClick={()=>setView('session-setup')} className="p-6 bg-green-500 hover:bg-green-600 text-white rounded-xl flex flex-col items-center gap-2">
                      <Camera size={40}/><span className="font-semibold">Asistencia</span>
                    </button>
                    <button onClick={()=>setView('qrcodes')} className="p-6 bg-purple-500 hover:bg-purple-600 text-white rounded-xl flex flex-col items-center gap-2">
                      <QrCode size={40}/><span className="font-semibold">C√≥digos QR</span>
                    </button>
                    <button onClick={()=>setView('history')} className="p-6 bg-amber-500 hover:bg-amber-600 text-white rounded-xl flex flex-col items-center gap-2">
                      <ClipboardList size={40}/><span className="font-semibold">Historial</span><span className="text-sm">{sessions.length}</span>
                    </button>
                  </div>
                  <button onClick={()=>setView('stats')} className="w-full p-4 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg flex items-center justify-center gap-2">
                    <BarChart3 size={20}/>Estad√≠sticas
                  </button>
                </div>
              )}

            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
